<div class="p-18">
    <div class="card">
        <p-toast />
        <p-toolbar class="mb-6">
            <ng-template #start>
                <p-button label="Nuevo" icon="pi pi-plus" class="mr-2" (onClick)="openNew()" />
                <p-button severity="danger" label="Eliminar" icon="pi pi-trash" outlined
                    (onClick)="deleteSelectedProducts()" [disabled]="!selectedProducts || !selectedProducts.length" />
            </ng-template>

            <ng-template #end>
                <p-fileUpload mode="basic" accept="image/*" [maxFileSize]="1000000" label="Importar" chooseLabel="Import"
                    auto customUpload class="mr-2 inline-block" [chooseButtonProps]="{ severity: 'secondary' }" />
                <p-button label="Exportar" icon="pi pi-upload" severity="secondary" (onClick)="exportCSV($event)" />
            </ng-template>
        </p-toolbar>

        <p-table #dt [value]="products" [rows]="10" [columns]="cols" [paginator]="true"
            [globalFilterFields]="['name', 'country.name', 'representative.name', 'status']"
             [(selection)]="selectedProducts" [rowHover]="true" dataKey="id"
            currentPageReportTemplate="Mostrando {first} de {last} de {totalRecords} productos"
            [showCurrentPageReport]="true">
            <ng-template #caption>
                <div class="flex items-center justify-between">
                    <h5 class="m-0">Productos</h5>
                    <p-iconfield>
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="onGlobalFilter($event)" placeholder="Buscar..." />
                    </p-iconfield>
                </div>
            </ng-template>
            <ng-template #header>
                <tr>
                    <th style="width: 3rem">
                        <p-tableHeaderCheckbox />
                    </th>
                    <th>Imagen</th>
                    <th pSortableColumn="name" >
                        <div class="flex items-center gap-2">
                            Nombre
                            <p-sortIcon field="name" />
                        </div>
                    </th>
                    
                    <th pSortableColumn="price" >
                        <div class="flex items-center gap-2">
                            Precio
                            <p-sortIcon field="price" />
                        </div>
                    </th>
                    <th pSortableColumn="rating">
                        <div class="flex items-center gap-2">
                           En Stock
                        </div>
                    </th>
                    <th pSortableColumn="inventoryStatus">
                        <div class="flex items-center gap-2">
                            Status
                            <p-sortIcon field="inventoryStatus" />
                        </div>
                    </th>
                </tr>
            </ng-template>
            <ng-template #body let-product>
                <tr>
                    
                    <td style="width: 3rem">
                        <p-tableCheckbox [value]="product" />
                    </td>

                    <td>
                        <img [src]="product.image_url"
                            [alt]="product.name" style="height: 64px; width: 64px; object-fit: cover;" class="rounded" />
                    </td>

                    <td>{{ product.name }}</td>
                    
                    <td>{{ product.price | currency: '₡' }}</td>
                    <td>
                        {{ product.stock_quantity }}
                    </td>
                    <td>
                        <p-tag [value]="product.stock_quantity > 0? 'Activo':'Inactivo'" [severity]="getSeverity(product.stock_quantity)" />
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <p-dialog [(visible)]="productDialog" [style]="{ width: '450px' }" header="Product Details" [modal]="true">
            <ng-template #content>
                <form [formGroup]="productForm" (ngSubmit)="saveProduct()" class="p-fluid grid gap-3">

                    <div class="col-12">
                        <p-floatLabel>
                            <input pInputText id="name" formControlName="name" />
                            <label for="name">Nombre</label>
                        </p-floatLabel>
                        <small *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched"
                            class="p-error">
                            El nombre es requerido (máx. 200 caracteres)
                        </small>
                    </div>

                    <div class="col-12">
                        <p-floatLabel>
                            <input pInputText id="description" formControlName="description" />
                            <label for="description">Descripción</label>
                        </p-floatLabel>
                    </div>

                    <div class="col-6">
                        <p-floatLabel>
                            <p-inputNumber id="price" formControlName="price" mode="decimal" [min]="0"
                                [step]="0.01"></p-inputNumber>
                            <label for="price">Precio</label>
                        </p-floatLabel>
                    </div>

                    <div class="col-6">
                        <p-floatLabel>
                            <p-inputNumber id="stock_quantity" formControlName="stock_quantity"
                                [min]="0"></p-inputNumber>
                            <label for="stock_quantity">Cantidad en Stock</label>
                        </p-floatLabel>
                    </div>

                    <div class="col-6">
                        <p-floatLabel>
                            <p-inputNumber id="min_stock_level" formControlName="min_stock_level"
                                [min]="0"></p-inputNumber>
                            <label for="min_stock_level">Nivel Mínimo de Stock</label>
                        </p-floatLabel>
                    </div>

                    <div class="col-12">
                        <p-floatLabel>
                            <input pInputText id="image_url" formControlName="image_url" />
                            <label for="image_url">URL de Imagen</label>
                        </p-floatLabel>
                    </div>


                    <div class="col-12 mt-3 text-right">
                        <button pButton type="submit" label="Guardar" icon="pi pi-save"
                            [disabled]="productForm.invalid"></button>
                    </div>
                </form>
            </ng-template>

            
        </p-dialog>

        <p-confirmDialog [style]="{ width: '450px' }" />
    </div>

</div>